models:
  - name: dbt_orders
    description: 'This table contains information on all the confirmed orders and
      their status'
    meta:
      label: Orders
      spotlight:
        owner: joao@lightdash.com
      parameters:
        orders_dim_toggle:
          label: "Browser/Partner/Referrer"
          description: "Swap between browser, partner, referrer"
          options:
            - "browser"
            - "referrer"
            - "partner_name"
          default: "partner_name"
          multiple: false
        date_range:
          label: "Date Range"
          description: "Choose a date range"
          options:
            - "yesterday"
            - "last 7 days"
            - "last 30 days"
          default: "last 7 days"
        custom_range_start:
          label: "Start of custom date range"
          description: "The start of the custom date range"
          type: date
        custom_range_end:
          label: "End of custom date range"
          description: "The end of the custom date range"
          type: date
    columns:
      - name: order_id
        description: 'Unique Order ID for the order.'
        meta:
          metrics:
            count_distinct_order_id:
              type: count_distinct
              label: 'Order Volume'
              description: 'Total number of orders placed by customers. Watch your garden grow!'
              spotlight:
                visibility: show
                categories:
                  - verified
                  - sales
          dimension:
            type: string
      - name: order_date
        description: 'Timestamp of order placement by user.'
        meta:
          dimension:
            time_intervals:
              [
                'HOUR',
                'MINUTE_OF_HOUR_NUM',
                'HOUR_OF_DAY_NUM',
                'DAY',
                'DAY_OF_WEEK_INDEX',
                'DAY_OF_MONTH_NUM',
                'DAY_OF_YEAR_NUM',
                'DAY_OF_WEEK_NAME',
                'WEEK',
                'WEEK_NUM',
                'MONTH',
                'MONTH_NUM',
                'MONTH_NAME',
                'QUARTER',
                'QUARTER_NUM',
                'QUARTER_NAME',
                'YEAR'
              ]
            sql: >
              timestamp_add(
                ${TABLE}.order_date,
                interval timestamp_diff(current_timestamp(), timestamp '2025-02-13 00:00:00', second) second
              )
            type: timestamp
          additional_dimensions:
            is_sunday:
              description: true if the date is a sunday
              type: boolean
              sql: EXTRACT(DAYOFWEEK FROM ${order_date}) = 1
            order_date_period:
              description: Date period (current period or previous period or previous year or
                out of range) chosen by the date_range parameter
              type: string
              sql: >
                case
                  -- current period
                  when (
                    (${lightdash.parameters.dbt_orders.date_range} = 'yesterday' and date(${order_date}) = date_sub(current_date(), interval 1 day)) or
                    (${lightdash.parameters.dbt_orders.date_range} = 'last 7 days' and date(${order_date}) between date_sub(current_date(), interval 7 day) and date_sub(current_date(), interval 1 day)) or
                    (${lightdash.parameters.dbt_orders.date_range} = 'last 30 days' and date(${order_date}) between date_sub(current_date(), interval 30 day) and date_sub(current_date(), interval 1 day))
                  )
                  then 'current period'

                  -- previous period
                  when (
                    (${lightdash.parameters.dbt_orders.date_range} = 'yesterday' and date(${order_date}) = date_sub(current_date(), interval 2 day)) or
                    (${lightdash.parameters.dbt_orders.date_range} = 'last 7 days' and date(${order_date}) between date_sub(current_date(), interval 14 day) and date_sub(current_date(), interval 8 day)) or
                    (${lightdash.parameters.dbt_orders.date_range} = 'last 30 days' and date(${order_date}) between date_sub(current_date(), interval 60 day) and date_sub(current_date(), interval 31 day))
                  )
                  then 'previous period'

                  -- previous year
                  when (
                    (${lightdash.parameters.dbt_orders.date_range} = 'yesterday' and date(${order_date}) = date_sub(date_sub(current_date(), interval 1 year), interval 1 day)) or
                    (${lightdash.parameters.dbt_orders.date_range} = 'last 7 days' and date(${order_date}) between date_sub(date_sub(current_date(), interval 1 year), interval 7 day) and date_sub(date_sub(current_date(), interval 1 year), interval 1 day)) or
                    (${lightdash.parameters.dbt_orders.date_range} = 'last 30 days' and date(${order_date}) between date_sub(date_sub(current_date(), interval 1 year), interval 30 day) and date_sub(date_sub(current_date(), interval 1 year), interval 1 day))
                  )
                  then 'previous year'

                  else 'out of range'
                end
            order_date_custom_period:
              description: Date period bucket based on custom Start date and End date parameters
              type: string
              sql: |
                case
                  --invalid date range 
                  when ${lightdash.parameters.dbt_orders.custom_range_start} is null
                    or ${lightdash.parameters.dbt_orders.custom_range_end} is null
                    or ${lightdash.parameters.dbt_orders.custom_range_start} > ${lightdash.parameters.dbt_orders.custom_range_end}
                    then 'invalid date range'

                  --current period 
                  when ${order_date_day} >= ${lightdash.parameters.dbt_orders.custom_range_start} 
                    and ${order_date_day} <= ${lightdash.parameters.dbt_orders.custom_range_end}
                    then 'current period'

                  --previous period
                  when ${order_date_day} between date_sub(
                    ${lightdash.parameters.dbt_orders.custom_range_start},
                    interval (date_diff(
                      ${lightdash.parameters.dbt_orders.custom_range_end},
                      ${lightdash.parameters.dbt_orders.custom_range_start},
                      day
                    ) + 1) day
                  ) and date_sub(
                    ${lightdash.parameters.dbt_orders.custom_range_end},
                    interval (date_diff(
                      ${lightdash.parameters.dbt_orders.custom_range_end},
                      ${lightdash.parameters.dbt_orders.custom_range_start},
                      day
                    ) + 1) day
                  )
                    then 'previous period'

                  --previous year
                  when date(${order_date_day}) between date_sub(${lightdash.parameters.dbt_orders.custom_range_start}, interval 1 year)
                    and date_sub(${lightdash.parameters.dbt_orders.custom_range_end}, interval 1 year)
                    then 'previous year'
  
                  else 'out of range'
                end
      - name: partner_id
        description: 'ID of the partner that is fulfilling the order.'
        meta:
          dimension:
            type: string
      - name: partner_name
        description: 'Full name of the partner that is fulfilling the order.'
        meta:
          dimension:
            urls:
              - url: https://analytics.lightdash.cloud/projects/8a223608-a1e4-426e-adcd-0598ea72b9f8/dashboards/3ee80f6e-5cb2-4375-b313-d2ad9126aece/view?filters=%7B"dimensions"%3A%5B%7B"id"%3A"fc5f8c1a-7673-4054-ba00-765d33033bfe"%2C"operator"%3A"equals"%2C"target"%3A%7B"fieldId"%3A"dbt_orders_partner_name"%2C"tableName"%3A"dbt_orders"%2C"fieldName"%3A"partner_name"%7D%2C"disabled"%3Afalse%2C"values"%3A%5B"${
                  value.formatted | url_encode
                  }"%5D%7D%5D%2C"metrics"%3A%5B%5D%2C"tableCalculations"%3A%5B%5D%7D
                label: View partner KPI dashboard
              - url: https://docs.lightdash.com/references/dimensions#urls
                label: View partner account in Salesforce
            colors:
              "Redwood Ranch": "#5E4CFF"
              "Happy Harvesters": "#DBFE95"
              "Peat, Fruits and Leaves": "#8001FE"
              "Sprout Society": "#30CF87"
              "Roots & Shoots": "#ED651C"
              "Trowels R Us": "#FFC54D"
              "Plant Paradise": "#FF0E53"
              "Garden of Sweden": "#D1CCFF"
              "Potted Paradise": "#EDFBD0"
            type: string
          additional_dimensions:
            orders_dim:
              label: Browser/Partner/Referrer
              type: string
              description: Use this dimension to swap between referrer, partner_name, browser
              sql: |
                case 
                  when ${lightdash.parameters.dbt_orders.orders_dim_toggle} = 'partner_name' then ${partner_name}
                  when ${lightdash.parameters.dbt_orders.orders_dim_toggle} = 'browser' then ${browser}
                  when ${lightdash.parameters.dbt_orders.orders_dim_toggle} = 'referrer' then ${referrer}
                end
            selected_dim:
              label: Selected dimension
              type: string
              description: The dimension that is currently selected in the orders_dim_toggle
                parameter
              sql: ${lightdash.parameters.dbt_orders.orders_dim_toggle}
      - name: partner_logo
        description: 'URL of the partner logo'
        meta:
          dimension:
            type: string
            image:
              url: "${value.raw}"
              width: 128
              height: 128
              fit: cover
      - name: partner_commission
        description: 'Commission rate the specified parter charges, as a decimal fraction.'
        meta:
          dimension:
            type: number
      - name: currency
        description: 'Three letter international currency code for the currency the
          order was paid with.'
        meta:
          dimension:
            type: string
      - name: basket_total
        description: 'Sum of item prices for each item within the basket.'
        meta:
          dimension:
            format: '[$$]#,##0'
            type: number
          metrics:
            sum_of_basket_total:
              type: sum
              label: 'Revenue'
              format: '[$$]#,##0'
              description: 'Total sales revenue from all orders.'
              spotlight:
                visibility: show
                categories:
                  - verified
                  - sales
                owner: giorgi@lightdash.com
            average_of_basket_total:
              type: average
              label: 'Average Order Value'
              format: '[$$]#,##0'
              description: 'Average revenue per order. How much customers spend per visit to the garden center.'
              spotlight:
                visibility: show
                categories:
                  - verified
      - name: profit
        description: 'Sum of item profits within the basket. Thus, the total profit of
          the order.'
        meta:
          dimension:
            format: '[$$]#,##0'
            type: number
          metrics:
            sum_of_profit:
              type: sum
              label: 'Profit'
              format: '[$$]#,##0'
              description: 'Total profit from all orders. The fruits of your labor!'
              spotlight:
                visibility: show
                categories:
                  - verified
                  - finance
            avg_profit:
              type: average
              label: 'Average Profit per Order'
              format: '[$$]#,##0'
              description: 'Average profit earned per order. Track your margins as they grow!'
              spotlight:
                visibility: hide
            median_profit:
              type: median
              label: 'Median Profit'
              format: '[$$]#,##0'
              spotlight:
                visibility: hide
      - name: referrer
        description: 'Source from which the user was linked to the Thyme to Shine website.'
        meta:
          dimension:
            type: string
      - name: user_id
        description: 'Unique user ID for the user that placed the order.'
        meta:
          metrics:
            count_distinct_user_id:
              type: count_distinct
              label: 'Unique Customers'
              description: 'Number of unique customers who placed orders.'
              spotlight:
                visibility: hide
                categories:
                  - verified
                  - marketing
          dimension:
            type: string
      - name: email
        description: 'Email address of the user that placed the order.'
        meta:
          dimension:
            urls:
              - url: 'mailto:${value.raw}?subject=Hello from Thyme Team!'
                label: Send email
            type: string
      - name: user_created_date
        description: 'Timestamp of user creation.'
        meta:
          dimension:
            sql: >
              timestamp_add(
                ${TABLE}.user_created_date,
                interval timestamp_diff(current_timestamp(), timestamp '2025-02-13 00:00:00', second) second
              )
            type: timestamp
      - name: browser
        description: 'Web browser that the user used to place the order.'
        meta:
          dimension:
            type: string
      - name: shipping_city
        description: 'Shipping city of the user that placed the order.'
        meta:
          dimension:
            type: string
      - name: shipping_country
        description: 'Shipping country of the user that placed the order.'
        meta:
          dimension:
            type: string
